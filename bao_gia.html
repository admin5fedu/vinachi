<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Báo Giá - Vinachi Việt Nam</title>
    <!-- Thư viện Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 text-gray-800;
        }

        /* Container that forces A4 size and allows scrolling on small screens */
        .a4-container {
            width: 21cm;
            min-height: 29.7cm;
            @apply bg-white shadow-xl rounded-xl mx-auto my-5 overflow-hidden;
        }

        /* Mobile styling: allow horizontal scroll to view fixed A4 content */
        @media (max-width: 768px) {
            body {
                @apply flex justify-start overflow-x-auto;
            }
            .a4-container {
                @apply mx-2 my-2 rounded-lg;
            }
        }

        .products-table th, .products-table td {
            border: 1px solid #e2e8f0;
        }
        
        /* Đảm bảo hình ảnh co giãn bên trong ô */
        .products-table .image-cell img {
            width: 100%; /* Giữ chiều rộng tối đa của ô */
            height: auto; /* Tự động điều chỉnh chiều cao để giữ tỷ lệ */
            max-width: 80px; /* Giới hạn kích thước tối đa của ảnh */
            max-height: 80px;
        }
        
        @media print {
            .footer {
                display: none;
            }
            .a4-container {
                box-shadow: none;
                margin: 0;
                border-radius: 0;
            }
            body {
                padding: 0;
                background: white;
                color: black;
            }
            
            /* Cải thiện hiển thị khi in: Chuyển hết về nền trắng chữ đen */
            body * {
                background: none !important;
                color: black !important;
            }

            .products-table th, .products-table td, .summary-table td {
                border-color: black !important;
            }

            .products-table th {
                background-color: white !important;
            }

            .summary-table .final-total {
                background-color: white !important;
            }
            
            /* Force exact colors for printing, primarily for black text */
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* Set page size and margins for print */
        @page {
            size: A4 portrait;
            margin: 1cm;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="a4-container">
        <!-- Đã chỉnh p-8 thành p-4 và leading-relaxed thành leading-snug để giảm khoảng cách -->
        <div class="p-4 text-center bg-gray-50 border-b-2 border-gray-200 rounded-t-xl">
            <div class="text-lg font-bold mb-2 text-gray-900" id="companyName">CÔNG TY TNHH VINACHI VIỆT NAM</div>
            <div class="text-xs leading-snug text-gray-600" id="companyBranches">
                <div>CS1: Kim Thiều - Hương Mạc - Từ Sơn - Bắc Ninh</div>
                <div>CS2: Km8+500 Đại lộ Thăng Long, Hoài Đức, Hà Nội</div>
                <div>CS3: Thạch Thất - Hà Nội</div>
            </div>
        </div>

        <!-- Đã chỉnh p-6 thành p-4 và gap-y-3 thành gap-y-2 để giảm khoảng cách -->
        <div class="p-4 bg-blue-50 border-b-2 border-blue-400">
            <div class="text-xl font-bold text-center text-blue-800 mb-3">BẢNG BÁO GIÁ</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 text-sm">
                <div class="flex items-center">
                    <span class="font-semibold text-gray-700 w-24 shrink-0">Kính gửi:</span>
                    <span id="customerName" class="font-medium text-gray-900">Khách hàng Chị Vân Giang</span>
                </div>
                <div class="flex items-center">
                    <span class="font-semibold text-gray-700 w-24 shrink-0">Số điện thoại:</span>
                    <span id="customerPhone" class="font-medium text-gray-900">0915711288</span>
                </div>
                <div class="flex items-center">
                    <span class="font-semibold text-gray-700 w-24 shrink-0">Địa chỉ:</span>
                    <span id="customerAddress" class="font-medium text-gray-900">Toà TC2 Vinsmart</span>
                </div>
                <div class="text-right font-medium text-gray-600 col-span-1 md:col-span-2 mt-2" id="quoteDate">Ngày 25 tháng 08 năm 2025</div>
            </div>
        </div>
        
        <div class="px-6">
            <table class="products-table w-full border-collapse">
                <thead>
                    <tr class="bg-gray-800 text-white text-sm font-semibold text-center">
                        <th class="p-3 w-[4%]">TT</th>
                        <th class="p-3 w-[10%]">Mã</th>
                        <th class="p-3 w-[25%]">Tên sản phẩm</th>
                        <th class="p-3 w-[8%]">Hình ảnh</th>
                        <th class="p-3 w-[6%]">ĐVT</th>
                        <th class="p-3 w-[6%]">Số lượng</th>
                        <th class="p-3 w-[10%]">Đơn giá</th>
                        <th class="p-3 w-[6%]">CK</th>
                        <th class="p-3 w-[10%]">Giá sau CK</th>
                        <th class="p-3 w-[10%]">Thành tiền</th>
                    </tr>
                </thead>
                <tbody id="productTableBody" class="text-xs text-center">
                    <!-- Product data will be inserted here by JavaScript -->
        
                </tbody>
            </table>
        </div>

        <div class="p-6">
            <!-- Đã thêm md:flex-row để đảm bảo layout theo hàng ngang trên các màn màn hình lớn, và flex-col trên mobile. -->
            <div class="flex flex-col md:flex-row gap-6">
                <div class="flex-1">
                    <table class="summary-table w-full max-w-sm ml-auto">
                        <tr class="border-b border-gray-300">
                            <td class="p-2 font-semibold text-gray-700">TỔNG ĐH</td>
                            <td class="p-2 text-right font-bold text-gray-900" id="totalOrder">16.941.000</td>
                        </tr>
                        <tr class="border-b border-gray-300">
                            <td class="p-2 font-semibold text-gray-700" id="vatRate">VAT (0,0%)</td>
                            <td class="p-2 text-right font-bold text-gray-900" id="vatAmount">0</td>
                        </tr>
                        <tr class="border-b border-gray-300">
                            <td class="p-2 font-semibold text-gray-700">Chi phí khác</td>
                            <td class="p-2 text-right font-bold text-gray-900" id="otherCosts">0</td>
                        </tr>
                        <tr class="border-b border-gray-300">
                            <td class="p-2 font-semibold text-gray-700">Giảm giá khác</td>
                            <td class="p-2 text-right font-bold text-gray-900" id="otherDiscounts">0</td>
                        </tr>
                        <tr class="final-total bg-gray-800 text-white text-lg font-bold">
                            <td class="p-3">TỔNG TIỀN</td>
                            <td class="p-3 text-right" id="finalTotal">16.941.000</td>
                        </tr>
                    </table>
                </div>
                
                <!-- Thay đổi flex-col gap-4 thành flex-row flex-1 và thêm flex-wrap để tránh xuống dòng -->
                <div class="flex flex-row flex-1 flex-wrap gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                        <div class="font-bold text-gray-800 mb-1">Tài khoản cá nhân</div>
                        <div class="text-sm text-gray-600 leading-relaxed">
                            STK: 09844434099<br>
                            Ngân hàng: TP Bank<br>
                            Chủ TK: VU THI HOA
                        </div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                        <div class="font-bold text-gray-800 mb-1">Tài khoản công ty</div>
                        <div class="text-sm text-gray-600 leading-relaxed">
                            STK: 119002673143<br>
                            Ngân hàng: Vietinbank - KCN Tiên Sơn - Bắc Ninh<br>
                            Chủ TK: CONG TY TNHH VINACHI VIET NAM
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="amount-words bg-blue-600 text-white font-bold p-4 text-center rounded-lg mx-6 my-4" id="amountInWords">
            Mười sáu triệu chín trăm bốn mươi mốt ngàn đồng
        </div>

        <div class="footer text-center text-sm italic text-gray-500 p-6 bg-gray-50 rounded-b-xl">
            Mọi thông tin thắc mắc, quy khách vui lòng liên hệ theo thông tin <span id="salespersonName">Nguyễn Thị Hiền</span> để được giải đáp.<br>
            Trân trọng cảm ơn!
        </div>
    </div>

    <script>
        // Function to get query parameters from the URL
        function getQueryParams() {
            const params = {};
            const queryString = window.location.search.substring(1);
            const regex = /([^&=]+)=([^&]*)/g;
            let m;
            while (m = regex.exec(queryString)) {
                params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
            }
            return params;
        }

        // Function to update the content based on URL parameters
        function updateContent() {
            const params = getQueryParams();

            // Update company info
            if (params.companyName) {
                document.getElementById('companyName').innerText = params.companyName;
            }
            if (params.branches) {
                const branchesArray = params.branches.split(';');
                const branchesDiv = document.getElementById('companyBranches');
                branchesDiv.innerHTML = branchesArray.map(branch => `<div>${branch}</div>`).join('');
            }
            
            // Update customer info
            if (params.customerName) {
                document.getElementById('customerName').innerText = params.customerName;
            }
            if (params.customerPhone) {
                document.getElementById('customerPhone').innerText = params.customerPhone;
            }
            if (params.customerAddress) {
                document.getElementById('customerAddress').innerText = params.customerAddress;
            }
            if (params.date) {
                document.getElementById('quoteDate').innerText = params.date;
            }
            
            // Update salesperson name
            if (params.salespersonName) {
                document.getElementById('salespersonName').innerText = params.salespersonName;
            }
            
            // Update summary table
            if (params.totalOrder) {
                document.getElementById('totalOrder').innerText = formatCurrency(params.totalOrder);
            }
            if (params.vatRate) {
                const vatValue = parseFloat(params.vatRate);
                const vatDisplay = (vatValue === 10) ? '10%' : ((vatValue * 100).toFixed(1).replace('.0', '') + '%');
                document.getElementById('vatRate').innerText = `VAT (${vatDisplay})`;
            }
            if (params.vatAmount) {
                document.getElementById('vatAmount').innerText = formatCurrency(params.vatAmount);
            }
            if (params.otherCosts) {
                document.getElementById('otherCosts').innerText = formatCurrency(params.otherCosts);
            }
            if (params.otherDiscounts) {
                document.getElementById('otherDiscounts').innerText = formatCurrency(params.otherDiscounts);
            }
            // Logic mới: ưu tiên giá trị finalTotal từ URL nếu có
            if (params.finalTotal) {
                document.getElementById('finalTotal').innerText = formatCurrency(params.finalTotal);
            }
            if (params.amountInWords) {
                document.getElementById('amountInWords').innerText = params.amountInWords;
            }

            // Check for product string data from URL
            if (params.productsString) {
                processProductString(params.productsString);
            } else if (params.products) {
                // Keep the old functionality for backwards compatibility
                try {
                    const products = JSON.parse(params.products);
                    const productTableBody = document.getElementById('productTableBody');
                    productTableBody.innerHTML = '';
                    products.forEach((product, index) => {
                        const row = document.createElement('tr');
                        row.className = 'odd:bg-gray-50 even:bg-white hover:bg-blue-50 transition-colors duration-200';
                        row.innerHTML = `
                            <td class="p-3">${index + 1}</td>
                            <td class="p-3">${product.code}</td>
                            <td class="p-3 text-left font-medium max-w-[200px]">${product.name}</td>
                            <td class="p-3 image-cell">${createImageTag(product.imageUrl)}</td>
                            <td class="p-3">${product.unit}</td>
                            <td class="p-3">${formatCurrency(product.quantity)}</td>
                            <td class="p-3 font-semibold text-green-600">${formatCurrency(product.price)}</td>
                            <td class="p-3">${(parseFloat(product.discountRate) * 100).toFixed(1).replace('.0', '')}%</td>
                            <td class="p-3 font-semibold text-green-600">${formatCurrency(product.priceAfterDiscount)}</td>
                            <td class="p-3 font-bold text-red-600">${formatCurrency(product.total)}</td>
                        `;
                        productTableBody.appendChild(row);
                    });
                } catch (e) {
                    console.error("Failed to parse products from URL:", e);
                }
            }
        }

        /**
         * Processes a special product string to populate the product table.
         * The string is formatted with `_b_` for new rows and `_a_` for new columns.
         * The columns are: Mã, Tên sản phẩm, Hình ảnh, ĐVT, Số lượng, Đơn giá, CK.
         * Other columns are calculated.
         * @param {string} productsString The input string to parse.
         */
        function processProductString(productsString) {
            const rows = productsString.split('_b_');
            const productTableBody = document.getElementById('productTableBody');
            productTableBody.innerHTML = ''; // Clear existing rows
            let totalOrderValue = 0;

            rows.forEach((rowString, index) => {
                const cols = rowString.split('_a_').map(col => col.trim());

                if (cols.length >= 7) {
                    const product = {};
                    product.code = cols[0];
                    product.name = cols[1];
                    product.imageUrl = cols[2]; // New column for image URL
                    product.unit = cols[3];
                    product.quantity = parseFloat(cols[4]) || 0;
                    product.price = parseFloat(cols[5].replace(/\./g, '')) || 0;
                    product.discountRate = parseFloat(cols[6]) || 0;

                    // Calculate derived values
                    product.priceAfterDiscount = product.price * (1 - product.discountRate);
                    product.total = product.quantity * product.priceAfterDiscount;

                    totalOrderValue += product.total;

                    // Create and append the new row
                    const row = document.createElement('tr');
                    row.className = 'odd:bg-gray-50 even:bg-white hover:bg-blue-50 transition-colors duration-200';
                    row.innerHTML = `
                        <td class="p-3">${index + 1}</td>
                        <td class="p-3">${product.code}</td>
                        <td class="p-3 text-left font-medium max-w-[200px]">${product.name}</td>
                        <td class="p-3 image-cell">${createImageTag(product.imageUrl)}</td>
                        <td class="p-3">${product.unit}</td>
                        <td class="p-3">${formatCurrency(product.quantity)}</td>
                        <td class="p-3 font-semibold text-green-600">${formatCurrency(product.price)}</td>
                        <td class="p-3">${(product.discountRate * 100).toFixed(1).replace('.0', '')}%</td>
                        <td class="p-3 font-semibold text-green-600">${formatCurrency(product.priceAfterDiscount)}</td>
                        <td class="p-3 font-bold text-red-600">${formatCurrency(product.total)}</td>
                    `;
                    productTableBody.appendChild(row);
                }
            });

            // Update the total order, but DO NOT overwrite final total
            document.getElementById('totalOrder').innerText = formatCurrency(totalOrderValue);
        }

        // Helper function to create an image tag with a fallback
        function createImageTag(url) {
            if (!url || !url.trim()) {
                // If no URL is provided, return a placeholder
                return `<div class="bg-gray-200 p-2 rounded text-center text-[11px] text-gray-500">Không có ảnh</div>`;
            }
            return `<img src="${url}" alt="Hình ảnh sản phẩm" class="object-cover rounded-md mx-auto" onerror="this.src='https://placehold.co/64x64/E5E7EB/9CA3AF?text=Ảnh+lỗi';">`;
        }

        // Helper function to format currency with dots
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(Math.round(amount));
        }

        // Run the update function when the page loads
        updateContent();
    </script>
</body>
</html>
