<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Báo Giá - Vinachi Việt Nam</title>
    <!-- Thư viện Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 text-gray-800;
        }

        /* Container that forces A4 size (210mm x 297mm) and allows scrolling on small screens */
        .a4-container {
            width: 21cm;
            min-height: 29.7cm;
            @apply bg-white shadow-2xl mx-auto my-5 overflow-hidden;
        }

        /* Mobile styling: allow horizontal scroll to view fixed A4 content */
        @media (max-width: 768px) {
            body {
                /* Ensure content starts from the left and allows scrolling */
                @apply flex justify-start overflow-x-auto;
            }
            .a4-container {
                @apply mx-2 my-2 rounded-lg;
            }
        }

        /* Table styling */
        .products-table th, .products-table td {
            border: 1px solid #e2e8f0; /* border-gray-200 */
        }
        
        /* Đảm bảo hình ảnh co giãn bên trong ô */
        .products-table .image-cell img {
            width: 100%; 
            height: auto; 
            max-width: 60px; /* Giới hạn kích thước tối đa của ảnh cho vừa A4 */
            max-height: 60px;
        }
        
        /* Print Styles */
        @media print {
            .footer {
                display: none; /* Ẩn vùng footer khi in */
            }
            .a4-container {
                box-shadow: none;
                margin: 0;
                border-radius: 0;
            }
            body {
                padding: 0;
                background: white;
                color: black;
            }
            
            /* Force black text and white background for printing clarity */
            body * {
                background: none !important;
                color: black !important;
            }

            .products-table th, .products-table td, .summary-table td {
                border-color: black !important;
            }

            .products-table th {
                background-color: white !important;
            }

            .summary-table .final-total {
                background-color: white !important;
            }
            
            /* Force exact colors for printing, primarily for black text */
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* Set page size and margins for print */
        @page {
            size: A4 portrait; /* Đảm bảo định dạng A4 dạng dọc */
            margin: 1cm;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 600;
            color: #1D4ED8;
            border-radius: 0.5rem;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="a4-container relative">
        <div id="loadingOverlay" class="loading-overlay hidden">
            Đang tải dữ liệu báo giá...
        </div>

        <!-- HEADER: Thông tin công ty (Nội dung này sẽ được cập nhật bằng JS dựa trên cột Logo) -->
        <div class="p-4 text-center bg-gray-50 border-b-2 border-gray-200">
            <div class="text-lg font-bold mb-1 text-gray-900" id="companyName">...</div>
            <div class="text-xs leading-snug text-gray-600" id="companyBranches">
                <!-- Nội dung chi nhánh sẽ được chèn bằng JS -->
            </div>
        </div>

        <!-- THÔNG TIN BÁO GIÁ & KHÁCH HÀNG -->
        <div class="p-4 bg-blue-50 border-b-2 border-blue-400">
            <!-- 1. Hiển thị ID Báo giá dưới tiêu đề -->
            <div class="text-xl font-bold text-center text-blue-800">BẢNG BÁO GIÁ</div>
            <div class="text-center text-sm italic text-gray-600 mb-3">
                (ID: <span id="quoteID" class="font-bold text-blue-800 not-italic">...</span>)
            </div>
            
            <!-- 2. Nội dung Kính gửi, SĐT, Địa chỉ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 text-sm">
                
                <!-- Kính gửi (Khách hàng) -->
                <div class="flex items-center">
                    <span class="font-semibold text-gray-700 w-24 shrink-0">Kính gửi:</span>
                    <span id="customerName" class="font-medium text-gray-900 flex-1">...</span>
                </div>
                
                <!-- Số điện thoại -->
                <div class="flex items-center">
                    <span class="font-semibold text-gray-700 w-24 shrink-0">Số điện thoại:</span>
                    <span id="customerPhone" class="font-medium text-gray-900">...</span>
                </div>
                
                <!-- Địa chỉ -->
                <div class="flex items-center">
                    <span class="font-semibold text-gray-700 w-24 shrink-0">Địa chỉ:</span>
                    <span id="customerAddress" class="font-medium text-gray-900 flex-1">...</span>
                </div>
                
                <div class="text-right font-medium text-gray-600 col-span-1 md:col-span-2 mt-2" id="quoteDate">...</div>
            </div>
        </div>
        
        <!-- BẢNG CHI TIẾT SẢN PHẨM -->
        <div class="px-4 py-2"> <!-- Giảm padding để tối ưu không gian A4 -->
            <table class="products-table w-full border-collapse">
                <thead>
                    <tr class="bg-gray-800 text-white text-xs font-semibold text-center uppercase"> <!-- Giảm cỡ chữ thành text-xs -->
                        <th class="p-2 w-[4%]">TT</th>
                        <th class="p-2 w-[10%]">Mã</th>
                        <th class="p-2 w-[25%]">Tên sản phẩm</th>
                        <th class="p-2 w-[8%]">Hình ảnh</th>
                        <th class="p-2 w-[6%]">ĐVT</th>
                        <th class="p-2 w-[6%]">SL</th>
                        <th class="p-2 w-[10%]">Đơn giá</th>
                        <th class="p-2 w-[6%]">CK</th>
                        <th class="p-2 w-[10%]">Giá sau CK</th>
                        <th class="p-2 w-[10%]">Thành tiền</th>
                    </tr>
                </thead>
                <tbody id="productTableBody" class="text-[11px] text-center"> <!-- Cỡ chữ nhỏ hơn cho nội dung -->
                    <!-- Dữ liệu sản phẩm sẽ được chèn vào đây từ Google Sheet -->
                    <tr><td colspan="10" class="p-4 text-center text-gray-500">Không có dữ liệu chi tiết sản phẩm.</td></tr>
                </tbody>
            </table>
        </div>

        <!-- TỔNG KẾT & THÔNG TIN THANH TOÁN -->
        <div class="p-4">
            <div class="flex flex-col md:flex-row gap-4">
                
                <!-- Bảng tổng kết -->
                <div class="md:w-1/2 w-full">
                    <table class="summary-table w-full md:max-w-sm ml-auto text-sm">
                        <tr class="border-b border-gray-300">
                            <td class="p-2 font-semibold text-gray-700">TỔNG ĐH</td>
                            <td class="p-2 text-right font-bold text-gray-900" id="totalOrder">...</td>
                        </tr>
                        <tr class="border-b border-gray-300">
                            <td class="p-2 font-semibold text-gray-700" id="vatRate">VAT (0,0%)</td>
                            <td class="p-2 text-right font-bold text-gray-900" id="vatAmount">...</td>
                        </tr>
                        <tr class="border-b border-gray-300">
                            <td class="p-2 font-semibold text-gray-700">Chi phí khác</td>
                            <td class="p-2 text-right font-bold text-gray-900" id="otherCosts">...</td>
                        </tr>
                        <tr class="border-b border-gray-300">
                            <td class="p-2 font-semibold text-gray-700">Giảm giá khác</td>
                            <td class="p-2 text-right font-bold text-gray-900" id="otherDiscounts">...</td>
                        </tr>
                        <tr class="final-total bg-gray-800 text-white text-lg font-bold">
                            <td class="p-3">TỔNG TIỀN</td>
                            <td class="p-3 text-right" id="finalTotal">...</td>
                        </tr>
                    </table>
                </div>

                <!-- Thông tin chuyển khoản -->
                <div class="md:w-1/2 w-full flex flex-col gap-4">
                    <div class="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500">
                        <div class="font-bold text-gray-800 mb-1">Tài khoản cá nhân</div>
                        <div class="text-sm text-gray-600 leading-relaxed">
                            STK: 09844434099<br>
                            Ngân hàng: TP Bank<br>
                            Chủ TK: VU THI HOA
                        </div>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500">
                        <div class="font-bold text-gray-800 mb-1">Tài khoản công ty</div>
                        <div class="text-sm text-gray-600 leading-relaxed">
                            STK: 119002673143<br>
                            Ngân hàng: Vietinbank - KCN Tiên Sơn - Bắc Ninh<br>
                            Chủ TK: CONG TY TNHH VINACHI VIET NAM
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tổng tiền bằng chữ -->
        <div class="amount-words bg-blue-600 text-white font-bold p-3 text-center rounded-lg mx-4 mt-2 mb-4" id="amountInWords">
            Đang tải số tiền bằng chữ...
        </div>

        <!-- FOOTER: Chữ ký và Ghi chú liên hệ -->
        <div class="footer text-sm text-gray-800 p-4 bg-gray-100 border-t border-gray-200">
            <!-- Chữ ký -->
            <div class="flex justify-between text-center text-sm mb-4">
                <div class="w-1/3">
                    <div class="font-semibold text-gray-700">Khách hàng xác nhận</div>
                    <div class="italic text-xs mt-1">(Ký, ghi rõ họ tên)</div>
                </div>
                <div class="w-1/3">
                    <div class="font-semibold text-gray-700">Người lập phiếu</div>
                    <div class="italic text-xs mt-1" id="salespersonNameSign">(Nguyễn Thị Hiền)</div>
                </div>
            </div>
            <!-- Ghi chú liên hệ -->
            <div class="text-center italic text-gray-500 mt-2">
                Mọi thông tin thắc mắc, quý khách vui lòng liên hệ theo thông tin <span id="salespersonName">Nguyễn Thị Hiền</span> để được giải đáp.<br>
                Trân trọng cảm ơn!
            </div>
        </div>
    </div>

    <script>
        // CÁC THAM SỐ CẤU HÌNH API
        const SPREADSHEET_ID = '2PACX-1vRqDU43Zjz4NZXwIJWFllaMmxbFZEnTnMGaZa3YqMkkBw104E0E9ItxHOan42X2NrTWTjfF1_TGKzWL'; 
        const GID_MAIN_QUOTE = '949969846'; 
        const GID_QUOTE_DETAIL = '1582939880'; 

        // URL Tải CSV
        const URL_MAIN_QUOTE = `https://docs.google.com/spreadsheets/d/e/${SPREADSHEET_ID}/pub?gid=${GID_MAIN_QUOTE}&single=true&output=csv`;
        const URL_QUOTE_DETAIL = `https://docs.google.com/spreadsheets/d/e/${SPREADSHEET_ID}/pub?gid=${GID_QUOTE_DETAIL}&single=true&output=csv`;


        // Tên Cột (Header Name) - ĐÃ CẬP NHẬT THEO ĐÚNG TÊN BẠN CUNG CẤP TỪ SHEET
        const COL_NAMES = {
            // Sheet "Báo giá"
            MAIN_ID: 'ID',
            MAIN_CUSTOMER_NAME: 'Khách hàng',
            MAIN_CUSTOMER_PHONE: 'Số điện thoại',
            MAIN_CUSTOMER_ADDRESS: 'Địa chỉ',
            MAIN_DATE: 'Ngày báo giá',
            MAIN_TOTAL_ORDER: 'Tổng ĐH',
            MAIN_VAT_RATE: 'Tỷ lệ VAT',
            MAIN_VAT_AMOUNT: 'Tiền VAT',
            MAIN_OTHER_COSTS: 'Chi phí khác',
            MAIN_OTHER_DISCOUNTS: 'Giảm giá khác',
            MAIN_FINAL_TOTAL: 'Tổng tiền cuối',
            MAIN_AMOUNT_IN_WORDS: 'Bằng chữ',
            MAIN_SALESPERSON: 'Người lập phiếu',
            MAIN_LOGO: 'Logo',

            // Sheet "Báo giá CT" (Đã cập nhật tên cột chi tiết theo yêu cầu mới)
            DETAIL_QUOTE_ID: 'Báo giá',
            DETAIL_CODE: 'Mã sản phẩm', 
            DETAIL_NAME: 'Tên sản phẩm',
            DETAIL_IMAGE_URL: 'Hình ảnh', 
            DETAIL_UNIT: 'ĐVT',
            DETAIL_QUANTITY: 'Số lượng', 
            DETAIL_PRICE: 'Đơn giá', 
            DETAIL_DISCOUNT_RATE: 'Chiết khấu', 
            DETAIL_PRICE_AFTER_DISCOUNT: 'Giá sau CK',
            DETAIL_TOTAL: 'Thành tiền',
        };

        const DEFAULT_PLACEHOLDER = '...';

        // Hàm lấy tham số truy vấn từ URL
        function getQueryParams() {
            const params = {};
            const queryString = window.location.search.substring(1);
            const regex = /([^&=]+)=([^&]*)/g;
            let m;
            while (m = regex.exec(queryString)) {
                params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
            }
            return params;
        }

        // Hàm chuyển đổi định dạng tiền tệ (thêm dấu chấm)
        function formatCurrency(amount, isQuantity = false) {
            const num = parseFloat(amount);
            if (isNaN(num)) return '0';
            
            if (isQuantity) {
                // Định dạng số lượng (có thể có số thập phân)
                return new Intl.NumberFormat('vi-VN', { 
                    minimumFractionDigits: (num !== Math.floor(num) ? 2 : 0), 
                    maximumFractionDigits: 2 
                }).format(num);
            }
            
            // Định dạng tiền tệ (làm tròn về số nguyên VND)
            return new Intl.NumberFormat('vi-VN').format(Math.round(num));
        }

        // Hàm tạo thẻ hình ảnh có fallback
        function createImageTag(url) {
            if (!url || !url.trim()) {
                return `<div class="bg-gray-200 p-1 rounded text-center text-[10px] text-gray-500">Không có ảnh</div>`;
            }
            // Sử dụng URL hình ảnh trực tiếp từ cột "Hình ảnh"
            return `<img src="${url}" alt="Hình ảnh sản phẩm" class="object-cover rounded-md mx-auto" onerror="this.src='https://placehold.co/60x60/E5E7EB/9CA3AF?text=Lỗi';">`;
        }
        
        // Hàm định dạng ngày tháng
        function formatDate(dateValue) {
            if (!dateValue) return DEFAULT_PLACEHOLDER;
            
            // Xử lý định dạng ngày tháng của Google Sheet trong CSV (thường là MM/DD/YYYY hoặc YYYY-MM-DD)
            try {
                let date;
                // Nếu là chuỗi, thử parse
                if (typeof dateValue === 'string') {
                    // Cố gắng thay thế dấu / bằng - để tăng khả năng parse trên nhiều trình duyệt
                    date = new Date(dateValue.replace(/\//g, '-')); 
                } else if (dateValue instanceof Date) {
                    date = dateValue;
                } else {
                    return dateValue || DEFAULT_PLACEHOLDER;
                }

                if (date && !isNaN(date)) {
                    const d = date.getDate();
                    const m = date.getMonth() + 1; 
                    const y = date.getFullYear();
                    return `Ngày ${d < 10 ? '0' + d : d} tháng ${m < 10 ? '0' + m : m} năm ${y}`;
                }
            } catch (e) {
                console.error("Lỗi định dạng ngày:", e);
            }
            return dateValue || DEFAULT_PLACEHOLDER;
        }

        /**
         * Hàm Parse CSV thành Array of Objects.
         * Giả định: Dòng đầu tiên là header, dấu phân cách là phẩy (,).
         * KHÔNG HỖ TRỢ các trường có chứa dấu phẩy bên trong (ví dụ: "text, with comma").
         */
        function parseCSV(csvText) {
            if (!csvText) return [];

            // Tách các hàng (sử dụng regex để loại bỏ hàng trống)
            const lines = csvText.split(/\r\n|\n/).filter(line => line.trim().length > 0);
            if (lines.length < 1) return [];

            // Dòng đầu tiên là header
            const headers = lines[0].split(',').map(header => header.trim().replace(/"/g, ''));
            const data = [];

            // Duyệt qua các dòng dữ liệu (bắt đầu từ dòng thứ 2)
            for (let i = 1; i < lines.length; i++) {
                // Tách các giá trị (chúng ta sẽ dùng regex cơ bản để xử lý dấu ngoặc kép)
                const values = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                
                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    // Loại bỏ dấu ngoặc kép và trim khoảng trắng
                    const value = values[j] ? values[j].trim().replace(/^"|"$/g, '') : null;
                    obj[headers[j]] = value;
                }
                data.push(obj);
            }
            
            console.log("[CSV Headers]:", headers);
            console.log("[CSV Data (First Item)]:", data[0]);
            
            return data;
        }


        // Hàm chung để lấy dữ liệu từ Google Sheet (CSV)
        async function fetchSheetData(csvUrl) {
            console.log(`[Fetching CSV]: ${csvUrl}`);

            try {
                // Sử dụng hàm fetch với chế độ không cache để đảm bảo dữ liệu mới nhất
                const response = await fetch(csvUrl, { cache: 'no-cache' });
                if (!response.ok) {
                    throw new Error(`Lỗi HTTP: ${response.status}`);
                }
                const csvText = await response.text();
                // Parse CSV thành mảng các đối tượng
                const data = parseCSV(csvText);
                return { data: data };
            } catch (error) {
                console.error(`Lỗi khi tải dữ liệu từ CSV URL:`, error);
                return { error: 'Network or parsing error', data: [] };
            }
        }
        
        // Hàm hiển thị thông báo lỗi
        function displayError(message) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('hidden', 'bg-blue-100');
            overlay.classList.add('bg-red-50');
            overlay.style.color = '#B91C1C';
            overlay.innerHTML = `LỖI: ${message}. Vui lòng kiểm tra lại ID báo giá và cấu hình sheet.`;
            
            // Xóa nội dung bảng chi tiết
            document.getElementById('productTableBody').innerHTML = '<tr><td colspan="10" class="p-4 text-center text-red-500 font-bold">LỖI: Không tìm thấy dữ liệu chi tiết.</td></tr>';
        }
        
        // Hàm tải và cập nhật nội dung
        async function updateContent() {
            const params = getQueryParams();
            const idBaoGia = params.IDbaogia;
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            // Khởi tạo/Đặt lại giá trị mặc định cho các phần tử
            document.getElementById('companyName').innerText = DEFAULT_PLACEHOLDER;
            document.getElementById('companyBranches').innerHTML = DEFAULT_PLACEHOLDER;
            document.getElementById('quoteID').innerText = DEFAULT_PLACEHOLDER;
            document.getElementById('customerName').innerText = DEFAULT_PLACEHOLDER;
            document.getElementById('customerPhone').innerText = DEFAULT_PLACEHOLDER;
            document.getElementById('customerAddress').innerText = DEFAULT_PLACEHOLDER;
            document.getElementById('quoteDate').innerText = DEFAULT_PLACEHOLDER;
            document.getElementById('totalOrder').innerText = DEFAULT_PLACEHOLDER;
            document.getElementById('vatRate').innerText = 'VAT (0,0%)';
            document.getElementById('vatAmount').innerText = DEFAULT_PLACEHOLDER;
            document.getElementById('otherCosts').innerText = DEFAULT_PLACEHOLDER;
            document.getElementById('otherDiscounts').innerText = DEFAULT_PLACEHOLDER;
            document.getElementById('finalTotal').innerText = DEFAULT_PLACEHOLDER;
            document.getElementById('amountInWords').innerText = 'Vui lòng cung cấp ID báo giá trên URL (ví dụ: ?IDbaogia=BG001) để xem dữ liệu.';
            document.getElementById('salespersonName').innerText = 'Nguyễn Thị Hiền';
            document.getElementById('salespersonNameSign').innerText = '(Nguyễn Thị Hiền)';
            
            const productTableBody = document.getElementById('productTableBody');
            productTableBody.innerHTML = '<tr><td colspan="10" class="p-4 text-center text-gray-500">Vui lòng cung cấp ID báo giá trên URL.</td></tr>';
            
            if (!idBaoGia) {
                loadingOverlay.classList.add('hidden');
                return;
            }
            
            loadingOverlay.classList.remove('hidden');
            document.getElementById('quoteID').innerText = idBaoGia;

            try {
                // 1. Tải và lọc thông tin Báo giá chính (Sheet "Báo giá")
                const mainDataResponse = await fetchSheetData(URL_MAIN_QUOTE);
                
                if (mainDataResponse.error) {
                    displayError(`Lỗi mạng/tải dữ liệu sheet Báo giá: ${mainDataResponse.error}`);
                    return;
                }
                
                // Lọc dữ liệu bằng IDbaogia
                const filteredMainQuotes = mainDataResponse.data.filter(
                    row => row[COL_NAMES.MAIN_ID] === idBaoGia
                );

                if (filteredMainQuotes.length === 0) {
                    displayError(`Không tìm thấy Báo giá có ID: ${idBaoGia} trong sheet Báo giá.`);
                    return;
                }
                
                const mainQuote = filteredMainQuotes[0];

                // 2. Cập nhật Logo/Header công ty
                const getValue = (colName) => mainQuote[colName] || '';
                const logoType = getValue(COL_NAMES.MAIN_LOGO)?.toLowerCase().trim();

                const companyNameEl = document.getElementById('companyName');
                const companyBranchesEl = document.getElementById('companyBranches');
                
                // Nội dung chi nhánh chung
                const commonBranches = `
                    <div>CS1: Kim Thiều - Hương Mạc - Từ Sơn - Bắc Ninh</div>
                    <div>CS2: Km8+500 Đại lộ Thăng Long, Hoài Đức, Hà Nội</div>
                    <div>CS3: Thạch Thất - Hà Nội</div>
                `;

                if (logoType === 'duraval') {
                    companyNameEl.innerText = 'CÔNG TY CỔ PHẦN DURAVAL VIỆT NAM';
                    companyBranchesEl.innerHTML = commonBranches;
                } else { // Mặc định là Vinachi hoặc bất kỳ giá trị nào khác
                    companyNameEl.innerText = 'CÔNG TY TNHH VINACHI VIỆT NAM';
                    companyBranchesEl.innerHTML = commonBranches;
                }


                // 3. Cập nhật thông tin khách hàng và tổng kết
                
                // Cập nhật thông tin khách hàng (SỬ DỤNG TÊN CỘT)
                document.getElementById('customerName').innerText = getValue(COL_NAMES.MAIN_CUSTOMER_NAME) || DEFAULT_PLACEHOLDER;
                document.getElementById('customerPhone').innerText = getValue(COL_NAMES.MAIN_CUSTOMER_PHONE) || DEFAULT_PLACEHOLDER;
                document.getElementById('customerAddress').innerText = getValue(COL_NAMES.MAIN_CUSTOMER_ADDRESS) || DEFAULT_PLACEHOLDER;
                
                // Định dạng ngày tháng
                const dateValue = getValue(COL_NAMES.MAIN_DATE);
                document.getElementById('quoteDate').innerText = formatDate(dateValue);
                
                // Cập nhật người lập phiếu
                const salesperson = getValue(COL_NAMES.MAIN_SALESPERSON) || 'Nguyễn Thị Hiền';
                document.getElementById('salespersonName').innerText = salesperson;
                document.getElementById('salespersonNameSign').innerText = `(${salesperson})`;

                // Cập nhật tổng kết
                const totalOrder = getValue(COL_NAMES.MAIN_TOTAL_ORDER);
                const vatRateText = getValue(COL_NAMES.MAIN_VAT_RATE);
                const vatAmount = getValue(COL_NAMES.MAIN_VAT_AMOUNT);
                const otherCosts = getValue(COL_NAMES.MAIN_OTHER_COSTS);
                const otherDiscounts = getValue(COL_NAMES.MAIN_OTHER_DISCOUNTS);
                const finalTotal = getValue(COL_NAMES.MAIN_FINAL_TOTAL);
                const amountInWords = getValue(COL_NAMES.MAIN_AMOUNT_IN_WORDS);
                
                // Ghi log giá trị Tổng tiền cuối để debug
                console.log(`[Báo giá chính] Giá trị cột '${COL_NAMES.MAIN_FINAL_TOTAL}':`, finalTotal);
                
                // Xử lý tỷ lệ VAT, có thể là số thập phân (0.1) hoặc % (10%)
                let vatRateDisplay = '0.0%';
                if (vatRateText) {
                    let rate = parseFloat(vatRateText);
                    if (rate > 1) { // Nếu nhập 10 thay vì 0.1
                        rate = rate / 100;
                    }
                    if (!isNaN(rate)) {
                        vatRateDisplay = (rate * 100).toFixed(1).replace('.0', '') + '%';
                    }
                }

                document.getElementById('totalOrder').innerText = formatCurrency(totalOrder);
                document.getElementById('vatRate').innerText = `VAT (${vatRateDisplay})`;
                document.getElementById('vatAmount').innerText = formatCurrency(vatAmount);
                document.getElementById('otherCosts').innerText = formatCurrency(otherCosts);
                document.getElementById('otherDiscounts').innerText = formatCurrency(otherDiscounts);
                document.getElementById('finalTotal').innerText = formatCurrency(finalTotal);
                document.getElementById('amountInWords').innerText = amountInWords || 'Không có số tiền bằng chữ.';

                // 4. Tải và lọc thông tin chi tiết sản phẩm (Sheet "Báo giá CT")
                const detailDataResponse = await fetchSheetData(URL_QUOTE_DETAIL);
                
                if (detailDataResponse.error) {
                    // Vẫn hiển thị thông tin chính, chỉ báo lỗi phần chi tiết
                    productTableBody.innerHTML = '<tr><td colspan="10" class="p-4 text-center text-red-500 font-bold">LỖI: Không tải được chi tiết sản phẩm.</td></tr>';
                    loadingOverlay.classList.add('hidden');
                    return;
                }

                // Lọc dữ liệu chi tiết bằng IDbaogia
                const filteredDetails = detailDataResponse.data.filter(
                    // Sử dụng cột 'Báo giá' trong sheet chi tiết để so sánh với ID Báo giá chính
                    row => row[COL_NAMES.DETAIL_QUOTE_ID] === idBaoGia
                );

                productTableBody.innerHTML = ''; // Xóa dữ liệu mẫu

                if (filteredDetails.length === 0) {
                    productTableBody.innerHTML = '<tr><td colspan="10" class="p-4 text-center text-gray-500">Không tìm thấy chi tiết sản phẩm cho báo giá này.</td></tr>';
                } else {
                    filteredDetails.forEach((product, index) => {
                        const getDetailValue = (colName) => product[colName] || '';
                        
                        // Lấy các giá trị (chuyển sang số nếu cần)
                        // Sử dụng tên cột mới: 'Số lượng'
                        const quantity = parseFloat(getDetailValue(COL_NAMES.DETAIL_QUANTITY)) || 0;
                        // Sử dụng tên cột mới: 'Đơn giá'
                        const price = parseFloat(getDetailValue(COL_NAMES.DETAIL_PRICE)) || 0;
                        
                        // CK có thể là 0.1, 0.05, hoặc 5%, 10%
                        // Sử dụng tên cột mới: 'Chiết khấu'
                        let discountRate = getDetailValue(COL_NAMES.DETAIL_DISCOUNT_RATE);
                        if (typeof discountRate === 'string' && discountRate.endsWith('%')) {
                            discountRate = parseFloat(discountRate.replace('%', '')) / 100;
                        } else {
                            discountRate = parseFloat(discountRate) || 0;
                        }
                        
                        // Ưu tiên dùng giá trị từ sheet nếu có, nếu không thì tự tính (tránh lỗi)
                        const priceAfterDiscount = parseFloat(getDetailValue(COL_NAMES.DETAIL_PRICE_AFTER_DISCOUNT)) || (price * (1 - discountRate));
                        const total = parseFloat(getDetailValue(COL_NAMES.DETAIL_TOTAL)) || (quantity * priceAfterDiscount);

                        const row = document.createElement('tr');
                        row.className = 'odd:bg-gray-50 even:bg-white hover:bg-blue-50 transition-colors duration-200';
                        row.innerHTML = `
                            <td class="p-2">${index + 1}</td>
                            <td class="p-2">${getDetailValue(COL_NAMES.DETAIL_CODE) || ''}</td>
                            <td class="p-2 text-left font-medium max-w-[200px]">${getDetailValue(COL_NAMES.DETAIL_NAME) || ''}</td>
                            <td class="p-2 image-cell">${createImageTag(getDetailValue(COL_NAMES.DETAIL_IMAGE_URL))}</td>
                            <td class="p-2">${getDetailValue(COL_NAMES.DETAIL_UNIT) || ''}</td>
                            <td class="p-2">${formatCurrency(quantity, true)}</td>
                            <td class="p-2 font-semibold text-green-600">${formatCurrency(price)}</td>
                            <td class="p-2">${(discountRate * 100).toFixed(0)}%</td>
                            <td class="p-2 font-semibold text-green-600">${formatCurrency(priceAfterDiscount)}</td>
                            <td class="p-2 font-bold text-red-600">${formatCurrency(total)}</td>
                        `;
                        productTableBody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error("Lỗi tổng quát khi cập nhật nội dung:", error);
                displayError("Lỗi không xác định khi tải dữ liệu.");
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        // Chạy hàm cập nhật khi trang tải xong
        window.onload = updateContent;
    </script>
</body>
</html>
