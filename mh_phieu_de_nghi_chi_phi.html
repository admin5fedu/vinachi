<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phi·∫øu ƒê·ªÅ Ngh·ªã Chi ph√≠</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Th∆∞ vi·ªán ƒë·ªÉ chuy·ªÉn HTML sang Canvas/H√¨nh ·∫£nh -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Th∆∞ vi·ªán ƒë·ªÉ t·∫°o file PDF t·ª´ Canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.5;
            margin: 0;
            padding: 0;
            color: #333;
            background-color: #f0f0f0;
            font-size: 13px;
        }

        .document-container {
            /* K√≠ch th∆∞·ªõc A5 ngang: 21cm x 14.8cm */
            width: 21cm;
            height: 14.8cm;
            padding: 1.5cm;
            margin: 30px auto;
            background-color: #fff;
            box-sizing: border-box;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-logo img {
            width: 50px;
            border-radius: 8px;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            text-align: center;
            margin-top: 4px;
        }

        .info-label {
            font-weight: 600;
            color: #1f2937;
        }

        .info-value {
            color: #1f2937;
            white-space: pre-line;
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .footer {
            text-align: center;
            font-weight: 600;
            font-size: 13px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            margin-top: 10px; /* Th√™m kho·∫£ng c√°ch nh·∫π cho ph·∫ßn ch·ªØ k√Ω */
        }

        /* TƒÉng c·ª° ch·ªØ cho c√°c l·ªõp Tailwind c·ª• th·ªÉ */
        .text-xs { font-size: 14px; }
        .text-sm { font-size: 16px; }

        /* ƒê·ªãnh nghƒ©a trang in A5 ngang */
        @page {
            size: A5 landscape;
            margin: 0;
        }

        @media print {
            .document-container {
                width: 100% !important;
                height: 100% !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 1.5cm !important;
                box-shadow: none !important;
                border: none !important;
            }
            body {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                font-size: 10pt !important;
            }
            .no-print {
                display: none !important;
            }
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                print-color-adjust: exact !important;
                color: #000 !important;
                font-family: 'Times New Roman', Times, serif !important;
                background: white !important;
                line-height: 1.2 !important;
            }
        }
    </style>
</head>
<body>

<div class="flex justify-end gap-2 p-4 no-print">
    <button id="printButton"
            class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded"
            data-html2canvas-ignore="true" onclick="printDocument()">
        In
    </button>
    <button id="downloadExcelButton"
            class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded"
            data-html2canvas-ignore="true" onclick="downloadExcel()">
        Xu·∫•t Excel
    </button>
    <button id="downloadPdfButton"
            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
            data-html2canvas-ignore="true" onclick="downloadPDF()">
        Xu·∫•t PDF
    </button>
</div>

<div id="document-content" class="document-container">
    <!-- Ph·∫ßn Header -->
    <div>
        <div class="header">
            <div class="header-logo">
                <img src="https://drive.google.com/thumbnail?id=12VL0Dxkj5d8xwLFVRslpHdtlWd4MHF5a" alt="Logo C√¥ng ty" />
            </div>
            <div>
                <p class="text-sm uppercase font-bold">C√îNG TY TNHH VINACHI VI·ªÜT NAM</p>
                <p class="text-xs italic">H∆∞∆°ng M·∫°c - Ph√π Kh√™ - T·ª´ S∆°n - B·∫Øc Ninh</p>
            </div>
            <!-- V·ªã tr√≠ ng√†y th√°ng -->
            <div class="text-xs italic ml-auto text-right">
                B·∫Øc Ninh, <?!= ngay_tao_phieu_full ?>
            </div>
        </div>

        <div class="section-title">PHI·∫æU ƒê·ªÄ NGH·ªä <?!= loai_phieu ?></div>
        <p class="text-center text-sm italic">(M√£ phi·∫øu: <?!= id ?>)</p>
        <p class="text-center text-sm font-semibold">K√≠nh g·ª≠i: Ph√≤ng T√†i ch√≠nh K·∫ø to√°n</p>

        <!-- Th√¥ng tin chi ti·∫øt -->
        <div class="two-col mt-2">
            <div>
                <p><span class="info-label">H·ªç t√™n:</span> <span class="info-value"><?!= ho_va_ten ?></span></p>
                <p><span class="info-label">Th·ªùi gian ƒë·ªÅ ngh·ªã:</span> <span class="info-value"><?!= tg_de_nghi ?></span></p>
                <p><span class="info-label">N·ªôi dung ƒë·ªÅ ngh·ªã:</span> <span class="info-value"><?!= nd_de_nghi ?></span></p>
            </div>
            <div>
                <p><span class="info-label">M√£ Nh√¢n Vi√™n:</span> <span class="info-value"><?!= mnv ?></span></p>
                <p><span class="info-label">Ph√≤ng:</span> <span class="info-value"><?!= phong ?></span></p>
            </div>
        </div>
        <div class="mt-2">
            <p><span class="info-label">Kho·∫£n m·ª•c:</span> <span class="info-value"><?!= khoan_muc ?></span></p>
            <p><span class="info-label">S·ªë ti·ªÅn:</span> <span class="text-red-600 font-bold"><?!= so_tien ?></span> VND</p>
            <p>
                <span class="info-label">B·∫±ng ch·ªØ:</span>
                <span class="italic"><?!= bang_chu ?></span>
            </p>
            <p><span class="info-label">Ghi ch√∫:</span><br><span class="info-value"><?!= ghi_chu ?></span></p>
        </div>
    </div>

    <!-- Ch·ªØ k√Ω ·ªü cu·ªëi phi·∫øu -->
    <div class="footer">
        <div>Ng∆∞·ªùi ƒë·ªÅ ngh·ªã</div>
        <div>Qu·∫£n l√Ω</div>
        <div>K·∫ø to√°n</div>
        <div>Ph√™ duy·ªát</div>
    </div>
</div>

<!-- Script x·ª≠ l√Ω bi·∫øn t·ª´ URL v√† c√°c h√†m ch·ª©c nƒÉng -->
<script>
    // H√†m x·ª≠ l√Ω vi·ªác in t√†i li·ªáu
    function printDocument() {
        window.print();
    }

    // H√†m xu·∫•t t√†i li·ªáu ra file PDF
    function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const input = document.getElementById('document-content');
        
        html2canvas(input, { scale: 2 }).then(canvas => {
            const imgData = canvas.toDataURL('image/jpeg');
            const pdf = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a5'
            });
            const imgWidth = 210;
            const imgHeight = canvas.height * imgWidth / canvas.width;
            
            pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
            pdf.save('phieu_de_nghi_chi_phi.pdf');
        });
    }

    // H√†m xu·∫•t ra file Excel
    function downloadExcel() {
        alert("Ch·ª©c nƒÉng xu·∫•t Excel ch∆∞a ƒë∆∞·ª£c h·ªó tr·ª£ cho lo·∫°i t√†i li·ªáu n√†y.");
    }

    // Chuy·ªÉn ƒë·ªïi s·ªë th√†nh ch·ªØ ti·∫øng Vi·ªát
    function convertNumberToVietnamese(num) {
        if (!num) return "";
        num = parseInt(num.toString().replace(/[^0-9]/g, ''));
        if (isNaN(num)) return "S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá";

        const units = ['', 'ngh√¨n', 'tri·ªáu', 't·ª∑', 'ngh√¨n t·ª∑'];
        const digits = ['kh√¥ng', 'm·ªôt', 'hai', 'ba', 'b·ªën', 'nƒÉm', 's√°u', 'b·∫£y', 't√°m', 'ch√≠n'];

        function readThreeDigits(n) {
            let result = '';
            let trƒÉm = Math.floor(n / 100);
            let chuc = Math.floor((n % 100) / 10);
            let donvi = n % 10;
            if (trƒÉm > 0) {
                result += digits[trƒÉm] + ' trƒÉm';
            }
            if (chuc === 0 && donvi === 0) {
                if (trƒÉm > 0) return result;
                else return 'kh√¥ng';
            }
            if (trƒÉm > 0) result += ' ';
            if (chuc === 1) {
                result += 'm∆∞·ªùi';
            } else if (chuc > 1) {
                result += digits[chuc] + ' m∆∞∆°i';
            }
            if (chuc > 0 && donvi > 0) result += ' ';
            if (donvi === 1) {
                if (chuc === 0) {
                    result += 'm·ªôt';
                } else {
                    result += 'm·ªët';
                }
            } else if (donvi === 5) {
                if (chuc > 0) {
                    result += 'lƒÉm';
                } else {
                    result += 'nƒÉm';
                }
            } else if (donvi > 0) {
                result += digits[donvi];
            }
            if (chuc === 0 && donvi > 0 && trƒÉm > 0) {
                result = result.replace('m∆∞∆°i', 'linh');
            }
            return result;
        }

        let result = '';
        let i = 0;
        let tempNum = num;
        while (tempNum > 0) {
            let threeDigits = tempNum % 1000;
            if (threeDigits > 0) {
                let text = readThreeDigits(threeDigits);
                result = text + ' ' + units[i] + ' ' + result;
            }
            tempNum = Math.floor(tempNum / 1000);
            i++;
        }
        return (result.trim() + ' ƒë·ªìng ch·∫µn').replace(/\s+/g, ' ');
    }

    // L·∫•y t·∫•t c·∫£ c√°c tham s·ªë t·ª´ URL
    const params = new URLSearchParams(window.location.search);
    const data = {};

    const soTien = params.get('so_tien') || '';
    const ngayTaoPhieu = params.get('ngay_tao_phieu') || '';
    const loaiPhieu = params.get('loai_phieu') || 'CHI T·∫†M ·ª®NG';

    // X·ª≠ l√Ω ng√†y th√°ng
    if (ngayTaoPhieu) {
        const parts = ngayTaoPhieu.split('/');
        if (parts.length === 3) {
            data.ngay_tao_phieu_full = `ng√†y ${parts[0]} th√°ng ${parts[1]} nƒÉm ${parts[2]}`;
        }
    }

    // X·ª≠ l√Ω s·ªë ti·ªÅn th√†nh ch·ªØ
    const soTienClean = soTien.replace(/\./g, '');
    data.bang_chu = convertNumberToVietnamese(soTienClean);

    // X·ª≠ l√Ω t√™n phi·∫øu
    data.loai_phieu = loaiPhieu.toUpperCase();

    // L·∫•y t·∫•t c·∫£ c√°c tham s·ªë c√≤n l·∫°i
    for (const [key, value] of params.entries()) {
        const decodedValue = decodeURIComponent(value).replace(/\n/g, "<br/>");
        data[key] = decodedValue;
    }

    // üîπ Thay th·∫ø placeholder trong to√†n b·ªô document
    document.body.innerHTML = document.body.innerHTML.replace(/<\?!=\s*(\w+)\s*\?>/g, (match, key) => {
        return data[key] || "";
    });

    // T·ª± ƒë·ªông in khi c√≥ tham s·ªë 'print' trong URL
    if (params.has('print')) {
        window.addEventListener('load', () => {
            window.print();
        });
    }
</script>
</body>
</html>
