<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách sản phẩm xuất VAT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            body { margin: 0; }
            .no-print { display: none; }
            
            /* CSS cho in ấn - màu đen dễ nhìn */
            th {
                background: #000 !important;
                color: #fff !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            td {
                color: #000 !important;
                background: #fff !important;
            }
            
            tr:nth-child(even) td {
                background: #f5f5f5 !important;
                color: #000 !important;
            }
            
            .bg-blue-100, .bg-green-100, .bg-yellow-100 {
                background: #e5e5e5 !important;
                color: #000 !important;
            }
        }
        
        .a4-container {
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 20mm;
            box-sizing: border-box;
        }
        
        @media (max-width: 768px) {
            .a4-container {
                width: 100%;
                min-height: 100vh;
                padding: 10px;
                box-shadow: none;
            }
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        
        @media (max-width: 768px) {
            table { font-size: 9px; }
        }
        
        th, td {
            border: 1px solid #d1d5db;
            padding: 8px 6px;
            text-align: left;
            vertical-align: top;
        }
        
        th {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:nth-child(even) {
            background-color: #f8fafc;
        }
        
        tr:hover {
            background-color: #e0f2fe;
        }
        
        .filter-input {
            width: 100%;
            padding: 4px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 10px;
            margin-top: 4px;
        }
        
        .filter-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        .clear-filters-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            height: 24px;
        }
        
        .clear-filters-btn:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }
        
        .export-excel-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            height: 24px;
        }
        
        .export-excel-btn:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }
        
        .stats-bar {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: 600;
            text-align: center;
        }
        
        .filter-section {
            border: 2px solid #e5e7eb;
        }
        
        .custom-dropdown {
            position: relative;
            width: 100%;
        }
        
        .dropdown-button {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            transition: all 0.2s;
            height: 40px;
            white-space: nowrap;
            overflow: hidden;
        }
        
        .dropdown-button span:first-child {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            margin-right: 8px;
        }
        
        .dropdown-button:hover {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        .dropdown-arrow {
            transition: transform 0.2s;
            color: #6b7280;
        }
        
        .dropdown-button.active .dropdown-arrow {
            transform: rotate(180deg);
        }
        
        .dropdown-content {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .dropdown-content.show {
            display: block;
        }
        
        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .dropdown-item:hover {
            background-color: #f8fafc;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item.selected {
            background-color: #eff6ff;
            color: #1d4ed8;
            font-weight: 500;
        }
        
        .dropdown-checkbox {
            width: 16px;
            height: 16px;
            accent-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="a4-container">
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-800 text-center mb-2">DANH SÁCH SẢN PHẨM XUẤT VAT</h1>
        </div>
        
        <!-- Khu vực bộ lọc -->
        <div class="filter-section bg-white p-4 rounded-lg shadow-md mb-6 no-print">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                <!-- Lọc Loại sản phẩm -->
                <div class="relative">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Loại sản phẩm</label>
                    <div class="custom-dropdown">
                        <div class="dropdown-button" onclick="toggleDropdown('loai')">
                            <span id="loai-display">Chọn loại...</span>
                            <span class="dropdown-arrow">▼</span>
                        </div>
                        <div class="dropdown-content" id="loai-dropdown">
                            <!-- Options sẽ được tạo tự động -->
                        </div>
                    </div>
                </div>
                
                <!-- Lọc Mã hàng -->
                <div class="relative">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mã hàng</label>
                    <div class="custom-dropdown">
                        <div class="dropdown-button" onclick="toggleDropdown('ma-hang')">
                            <span id="ma-hang-display">Chọn mã hàng...</span>
                            <span class="dropdown-arrow">▼</span>
                        </div>
                        <div class="dropdown-content" id="ma-hang-dropdown">
                            <!-- Options sẽ được tạo tự động -->
                        </div>
                    </div>
                </div>
                
                <!-- Tìm kiếm tên hàng -->
                <div class="relative">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tên hàng hóa</label>
                    <input 
                        type="text" 
                        id="ten-hang-search" 
                        placeholder="Nhập tên hàng để tìm kiếm..." 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm h-10"
                        oninput="handleProductNameSearch(this.value)"
                    >
                </div>
                
                <!-- Các nút thao tác -->
                <div class="relative">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Thao tác</label>
                    <div class="flex gap-2">
                        <button class="clear-filters-btn flex-1 text-xs py-1 px-2" onclick="clearAllFilters()">
                            Bỏ lọc
                        </button>
                        <button class="export-excel-btn flex-1 text-xs py-1 px-2" onclick="exportToExcel()">
                            Xuất Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th style="width: 5%; text-align: center;">TT</th>
                        <th style="width: 15%; text-align: center;">Mã hàng</th>
                        <th style="width: 40%; text-align: center;">Tên hàng hóa</th>
                        <th style="width: 8%; text-align: center;">ĐVT</th>
                        <th style="width: 10%; text-align: center;">SL</th>
                        <th style="width: 12%; text-align: center;">Giá xuất</th>
                        <th style="width: 10%; text-align: center;">Thuế suất</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dữ liệu sẽ được tải từ webapp -->
                </tbody>
            </table>
        </div>
        

    </div>

    <script>
        // Biến lưu trữ dữ liệu từ webapp
        let tableData = [];
        
        // Khởi tạo bộ lọc khi trang được tải
        document.addEventListener('DOMContentLoaded', function() {
            loadDataFromWebapp();
        });
        
        // Hàm tải dữ liệu từ webapp
        async function loadDataFromWebapp() {
            try {
                // Hiển thị loading
                const tbody = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Đang tải dữ liệu...</td></tr>';
                
                const response = await fetch('https://script.google.com/macros/s/AKfycbyw6nou2-DE_e749bLj69pZFOH7I9E_CUOAZQTFQdmbv9Fuq8TRMEebxLEHZcDzF3Cr2w/exec');
                const data = await response.json();
                
                tableData = data;
                renderTable(data);
                initializeFilters();
                
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
                const tbody = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-500">Không thể tải dữ liệu. Vui lòng thử lại sau.</td></tr>';
            }
        }
        
        // Hàm render bảng từ dữ liệu
        function renderTable(data) {
            const tbody = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // Xử lý dữ liệu
                const maHang = item['Mã hàng'] || '';
                const tenHang = item['Tên hàng hóa'] || '';
                const dvt = item['ĐVT'] || '';
                const soLuong = item['Số lượng tồn'] || 0;
                const giaXuat = item['Giá xuất'] || 0;
                const thueXuat = item['Thuế suất'] || 0;
                const loaiSP = item['Loại sản phẩm'] || '';
                
                // Chuyển đổi thuế suất từ decimal sang phần trăm
                const thueXuatPercent = (thueXuat * 100).toFixed(2) + '%';
                
                // Định dạng giá xuất với phân tách hàng nghìn
                const giaXuatFormatted = giaXuat.toLocaleString('vi-VN');
                
                // Xác định màu cho loại sản phẩm
                let loaiClass = 'bg-blue-100 text-blue-800';
                if (loaiSP === 'Loại B') {
                    loaiClass = 'bg-green-100 text-green-800';
                } else if (loaiSP === 'Loại C') {
                    loaiClass = 'bg-yellow-100 text-yellow-800';
                }
                
                row.innerHTML = `
                    <td class="text-center font-semibold">${index + 1}</td>
                    <td>${maHang}</td>
                    <td>${tenHang}</td>
                    <td class="text-center">${dvt}</td>
                    <td class="text-center font-semibold">${soLuong}</td>
                    <td class="text-center font-semibold">${giaXuatFormatted}</td>
                    <td class="text-center">${thueXuatPercent}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            updateStats();
        }
        
        // Biến lưu trữ các giá trị đã chọn
        const selectedFilters = {
            'ma-hang': [],
            'loai': [],
            'ten-hang': ''
        };
        
        // Hàm khởi tạo các dropdown filter từ dữ liệu webapp
        function initializeFilters() {
            if (tableData.length === 0) return;
            
            // Tập hợp dữ liệu unique cho từng cột
            const maHangSet = new Set();
            const loaiSet = new Set();
            const tenHangSet = new Set();
            
            tableData.forEach(item => {
                // Mã hàng
                if (item['Mã hàng']) {
                    maHangSet.add(item['Mã hàng']);
                }
                
                // Loại sản phẩm
                if (item['Loại sản phẩm']) {
                    loaiSet.add(item['Loại sản phẩm']);
                }
                
                // Tên hàng hóa
                if (item['Tên hàng hóa']) {
                    tenHangSet.add(item['Tên hàng hóa']);
                }
            });
            
            // Tạo dropdown items
            createDropdownItems('ma-hang', Array.from(maHangSet));
            createDropdownItems('loai', Array.from(loaiSet));
        }
        
        // Hàm tạo dropdown items
        function createDropdownItems(dropdownId, items) {
            const dropdown = document.getElementById(dropdownId + '-dropdown');
            dropdown.innerHTML = '';
            
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                div.innerHTML = `
                    <input type="checkbox" class="dropdown-checkbox" value="${item}" onchange="handleCheckboxChange('${dropdownId}', '${item}', this.checked)">
                    <span>${item}</span>
                `;
                dropdown.appendChild(div);
            });
        }
        
        // Hàm toggle dropdown
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId + '-dropdown');
            const button = dropdown.previousElementSibling;
            
            // Đóng tất cả dropdown khác
            document.querySelectorAll('.dropdown-content').forEach(d => {
                if (d !== dropdown) {
                    d.classList.remove('show');
                    d.previousElementSibling.classList.remove('active');
                }
            });
            
            // Toggle dropdown hiện tại
            dropdown.classList.toggle('show');
            button.classList.toggle('active');
        }
        
        // Hàm xử lý khi checkbox thay đổi
        function handleCheckboxChange(dropdownId, value, checked) {
            if (checked) {
                if (!selectedFilters[dropdownId].includes(value)) {
                    selectedFilters[dropdownId].push(value);
                }
            } else {
                selectedFilters[dropdownId] = selectedFilters[dropdownId].filter(v => v !== value);
            }
            
            updateDropdownDisplay(dropdownId);
            applyFilters();
        }
        
        // Hàm cập nhật hiển thị dropdown
        function updateDropdownDisplay(dropdownId) {
            const display = document.getElementById(dropdownId + '-display');
            const selected = selectedFilters[dropdownId];
            
            if (selected.length === 0) {
                const labels = {
                    'ma-hang': 'Chọn mã hàng...',
                    'loai': 'Chọn loại...',
                    'ten-hang': 'Chọn tên hàng...'
                };
                display.textContent = labels[dropdownId];
            } else if (selected.length === 1) {
                // Hiển thị tên ngắn gọn
                let displayText = selected[0];
                if (dropdownId === 'ma-hang' && displayText.length > 20) {
                    displayText = displayText.substring(0, 20) + '...';
                } else if (dropdownId === 'ten-hang' && displayText.length > 25) {
                    displayText = displayText.substring(0, 25) + '...';
                }
                display.textContent = displayText;
            } else {
                display.textContent = `${selected.length} mục`;
            }
        }
        
        // Hàm xử lý tìm kiếm tên hàng hóa
        function handleProductNameSearch(value) {
            selectedFilters['ten-hang'] = value.toLowerCase().trim();
            applyFilters();
        }
        
        // Đóng dropdown khi click bên ngoài
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.custom-dropdown')) {
                document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                    dropdown.classList.remove('show');
                    dropdown.previousElementSibling.classList.remove('active');
                });
            }
        });
        
        // Hàm áp dụng tất cả bộ lọc
        function applyFilters() {
            // Lấy giá trị các bộ lọc
            const selectedMaHang = selectedFilters['ma-hang'];
            const selectedLoai = selectedFilters['loai'];
            const searchTenHang = selectedFilters['ten-hang'];
            
            // Lọc dữ liệu
            const filteredData = tableData.filter(item => {
                // Lọc Mã hàng
                if (selectedMaHang.length > 0) {
                    if (!selectedMaHang.includes(item['Mã hàng'])) {
                        return false;
                    }
                }
                
                // Lọc Loại sản phẩm
                if (selectedLoai.length > 0) {
                    if (!selectedLoai.includes(item['Loại sản phẩm'])) {
                        return false;
                    }
                }
                
                // Tìm kiếm Tên hàng hóa
                if (searchTenHang) {
                    const tenHang = (item['Tên hàng hóa'] || '').toLowerCase();
                    if (!tenHang.includes(searchTenHang)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // Render lại bảng với dữ liệu đã lọc
            renderTable(filteredData);
        }
        
        // Hàm xóa tất cả bộ lọc
        function clearAllFilters() {
            // Reset selected filters
            selectedFilters['ma-hang'] = [];
            selectedFilters['loai'] = [];
            selectedFilters['ten-hang'] = '';
            
            // Uncheck tất cả checkbox
            document.querySelectorAll('.dropdown-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Reset dropdown displays
            updateDropdownDisplay('ma-hang');
            updateDropdownDisplay('loai');
            
            // Reset search input
            document.getElementById('ten-hang-search').value = '';
            
            // Hiển thị lại tất cả dữ liệu
            renderTable(tableData);
        }
        
        // Hàm cập nhật thống kê
        function updateStats() {
            // Không cần cập nhật thống kê nữa vì đã bỏ thanh thống kê
        }
        
        // Hàm xuất Excel
        function exportToExcel() {
            // Lấy dữ liệu hiện tại đang hiển thị (đã lọc)
            const table = document.getElementById('dataTable');
            const rows = table.querySelectorAll('tbody tr');
            
            if (rows.length === 0 || (rows.length === 1 && rows[0].cells[0].colSpan > 1)) {
                alert('Không có dữ liệu để xuất!');
                return;
            }
            
            // Tạo dữ liệu CSV
            let csvContent = '\uFEFF'; // BOM cho UTF-8
            
            // Header
            csvContent += 'TT,Mã hàng,Tên hàng hóa,ĐVT,SL,Giá xuất,Thuế suất\n';
            
            // Dữ liệu
            rows.forEach(row => {
                if (row.cells.length > 1) { // Bỏ qua các dòng thông báo
                    const rowData = [];
                    for (let i = 0; i < row.cells.length; i++) {
                        let cellText = row.cells[i].textContent.trim();
                        // Escape dấu phẩy và dấu ngoặc kép
                        if (cellText.includes(',') || cellText.includes('"')) {
                            cellText = '"' + cellText.replace(/"/g, '""') + '"';
                        }
                        rowData.push(cellText);
                    }
                    csvContent += rowData.join(',') + '\n';
                }
            });
            
            // Tạo và tải file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                
                // Tạo tên file với ngày giờ hiện tại
                const now = new Date();
                const dateStr = now.getFullYear() + 
                    String(now.getMonth() + 1).padStart(2, '0') + 
                    String(now.getDate()).padStart(2, '0') + '_' +
                    String(now.getHours()).padStart(2, '0') + 
                    String(now.getMinutes()).padStart(2, '0');
                
                link.setAttribute('download', `DanhSachSanPhamXuatVAT_${dateStr}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9769043f72d108a2',t:'MTc1NjQzODcxNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
